#ifndef DRIVER_WIFI_H // Исправлено: DRIVER_WIFI_H вместо DWIFI_H
#define DRIVER_WIFI_H

#include "esp_wifi.h"
#include "esp_netif.h"
#include "esp_err.h"

#ifdef __cplusplus
extern "C"
{
#endif

    /**
     * @brief Инициализация Wi-Fi ресурсов
     *
     * Функция инициализирует сетевой стек ESP-IDF, создает цикл событий по умолчанию
     * и инициализирует Wi-Fi драйвер. Должна вызываться один раз при старте приложения.
     *
     * @note Эта функция должна быть вызвана перед использованием любых других Wi-Fi функций
     */
    esp_err_t dw_resources_init(void);

    /**
     * @brief Запуск точки доступа (Access Point)
     *
     * Создает Wi-Fi точку доступа с указанной конфигурацией.
     *
     * @param ap_config Конфигурация точки доступа (если NULL, используется минимальная конфигурация)
     * @return esp_err_t ESP_OK при успешном запуске, код ошибки в случае неудачи
     *
     * @note Если точка доступа уже запущена, функция настраивает новые параметры
     */
    esp_err_t dw_access_point_start(const wifi_ap_config_t *ap_config);

    /**
     * @brief Остановка точки доступа
     *
     * Останавливает точку доступа, отключает всех подключенных клиентов
     * и освобождает связанные ресурсы.
     *
     * @return esp_err_t ESP_OK при успешной остановке, код ошибки в случае неудачи
     */
    esp_err_t dw_access_point_stop(void);

    /**
     * @brief Подключение к точке доступа (Station mode) с возможностью отключения авто-переподключения
     *
     * Подключается к указанной точке доступа в режиме клиента.
     *
     * @param sta_config Конфигурация клиента (может быть NULL для минимальной конфигурации)
     * @param event Указатель на пользовательский обработчик событий (может быть NULL)
     * @param arg Аргумент для пользовательского обработчика событий
     * @param auto_reconnect Флаг, включающий (true) или отключающий (false) автоматическое переподключение
     *                       при разрывах соединения.
     * @return esp_err_t ESP_OK при успешном начале подключения, код ошибки в случае неудачи
     *
     * @note Функция автоматически пытается восстановить соединение при разрывах *только если*
     *       auto_reconnect установлен в true.
     * @note Если sta_config == NULL, используется минимальная конфигурация по умолчанию
     */
    esp_err_t dw_station_connect_with_auto_reconnect(const wifi_sta_config_t *sta_config, esp_event_handler_t event, void *arg, bool auto_reconnect);

    /**
     * @brief Подключение к точке доступа (Station mode) с включенным авто-переподключением
     *
     * Подключается к указанной точке доступа в режиме клиента.
     * Эта функция является обёрткой для dw_station_connect_with_auto_reconnect,
     * вызывая её с auto_reconnect = true.
     *
     * @param sta_config Конфигурация клиента (может быть NULL для минимальной конфигурации)
     * @param event Указатель на пользовательский обработчик событий (может быть NULL)
     * @param arg Аргумент для пользовательского обработчика событий
     * @return esp_err_t ESP_OK при успешном начале подключения, код ошибки в случае неудачи
     *
     * @note Функция автоматически пытается восстановить соединение при разрывах
     * @note Если sta_config == NULL, используется минимальная конфигурация по умолчанию
     */
    esp_err_t dw_station_connect(const wifi_sta_config_t *sta_config, esp_event_handler_t event, void *arg);

    /**
     * @brief Отключение от точки доступа
     *
     * Отключается от текущей точки доступа и освобождает ресурсы режима клиента.
     * Отключает авто-переподключение.
     *
     * @return esp_err_t ESP_OK при успешном отключении, код ошибки в случае неудачи
     */
    esp_err_t dw_station_stop(void);

    /**
     * @brief Включение или отключение автоматического переподключения
     *
     * Управляет флагом, определяющим, будет ли устройство автоматически
     * пытаться переподключиться к точке доступа при разрыве соединения.
     *
     * @param enable true для включения автореконекта, false для отключения.
     */
    void dw_station_set_auto_reconnect(bool enable);

    /**
     * @brief Начало сканирования доступных точек доступа
     *
     * Инициирует асинхронное сканирование Wi-Fi сетей в окружающей среде.
     * Результаты сканирования доступны через dw_station_scan_result().
     *
     * @param event Указатель на пользовательский обработчик событий сканирования (может быть NULL)
     * @param arg Аргумент для пользовательского обработчика событий
     * @return esp_err_t ESP_OK при успешном начале сканирования, код ошибки в случае неудачи
     *
     * @note Сканирование выполняется асинхронно, результаты доступны по событию WIFI_EVENT_SCAN_DONE
     */
    esp_err_t dw_station_scan_start(esp_event_handler_t event, void *arg);

    /**
     * @brief Получение результатов сканирования
     *
     * Копирует результаты последнего сканирования в пользовательский буфер.
     * Память для результатов выделяется внутри функции и должна быть освобождена
     * с помощью dw_free_scan_result().
     *
     * @param out_count Указатель для возврата количества найденных точек доступа
     * @param out_list Указатель для возврата массива записей точек доступа
     * @return esp_err_t ESP_OK при успешном получении результатов, код ошибки в случае неудачи
     *
     * @warning Выделенная память должна быть освобождена с помощью dw_free_scan_result()
     */
    esp_err_t dw_station_scan_result(uint16_t *out_count, wifi_ap_record_t **out_list);

    /**
     * @brief Освобожение памяти результатов сканирования
     *
     * Освобождает память, выделенную функцией dw_station_scan_result().
     *
     * @param scan_list Указатель на массив записей точек доступа для освобождения
     * @return esp_err_t ESP_OK при успешном освобождении, ESP_ERR_INVALID_ARG если указатель NULL
     */
    esp_err_t dw_free_scan_result(wifi_ap_record_t *scan_list);

    /**
     * @brief Проверка наличия интернет-соединения
     *
     * Выполняет HTTP-запрос к публичному серверу для проверки доступности интернета.
     * Требует, чтобы устройство уже имело валидный IP-адрес в режиме STA.
     *
     * @return esp_err_t
     *         - ESP_OK: интернет доступен;
     *         - ESP_ERR_INVALID_STATE: нет IP-адреса или STA не активен;
     *         - ESP_ERR_NOT_FOUND: сетевой интерфейс STA не найден;
     *         - ESP_ERR_INVALID_RESPONSE: сервер недоступен или вернул ошибку;
     *         - другие: ошибки инициализации HTTP-клиента.
     *
     * @note Функция блокирующая. Не вызывать из обработчиков прерываний или событий.
     * @note Требует подключения компонента esp_http_client в проекте.
     */
    esp_err_t dw_check_internet_connection(void);

    /**
     * @brief Очистка всех Wi-Fi ресурсов
     *
     * Полная очистка всех выделенных ресурсов, включая память для результатов сканирования,
     * сетевые интерфейсы и мьютекс синхронизации. Должна вызываться при завершении работы.
     *
     * @note Эта функция должна вызываться один раз при завершении работы с Wi-Fi
     */
    void dw_wifi_cleanup(void);

    /**
     * @brief Преобразование кода ошибки Wi-Fi в строку
     *
     * Преобразует код причины отключения Wi-Fi в человекочитаемую строку.
     *
     * @param reason Код причины отключения Wi-Fi
     * @return const char* Указатель на строку с описанием причины
     *
     * @note Возвращает "Unknown reason" для неизвестных кодов
     */
    const char *wifi_reason_to_string(wifi_err_reason_t reason);

    /**
     * @brief Установка пользовательского обработчика событий
     *
     * Устанавливает пользовательский обработчик событий.
     *
     * @param event Указатель на пользовательский обработчик событий подключения
     *
     * @note Возможно передать NULL, для отключения пользовательского обработчика
     */
    void dw_set_user_sta_event_handler(esp_event_handler_t event);

    /**
     * @brief Установка hostname для сетевого интерфейса Wi-Fi
     *
     * @param wifi_interface Интерфейс Wi-Fi (WIFI_IF_STA или WIFI_IF_AP)
     * @param hostname Имя хоста (до 63 символов)
     * @return esp_err_t ESP_OK при успешной установке, иначе код ошибки
     */
    esp_err_t dw_set_hostname_to_netif(wifi_interface_t wifi_interface, const char *hostname);

    // Функция для проверки состояния сканирования
    bool dw_is_scanning(void);

    // Функция для принудительного сброса флага сканирования
    void dw_force_scan_reset(void);

#ifdef __cplusplus
}
#endif

#endif // DRIVER_WIFI_H